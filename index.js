// index.js

const express = require('express');
const { Client } = require('@notionhq/client');
const dotenv = require('dotenv');
const { Configuration, OpenAIApi } = require("openai");

dotenv.config();

const app = express();
app.use(express.json());

const notion = new Client({ auth: process.env.NOTION_TOKEN });

const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
});

async function classifyMindFactors(text) {
  try {
    const completion = await openai.chat.completions.create({
      model: "gpt-4", // ã¾ãŸã¯ gpt-3.5-turbo ãªã©ã€åˆ©ç”¨å¯èƒ½ãªãƒ¢ãƒ‡ãƒ«
      messages: [
        {
          role: "system",
          content: `ã‚ãªãŸã¯ä»æ•™ã®å”¯è­˜å­¦æ´¾ã®å°‚é–€å®¶ã§ã™ã€‚ä»¥ä¸‹ã®è¦å‰‡ã«åŽ³å¯†ã«å¾“ã„ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç™ºè¨€ã«å«ã¾ã‚Œã‚‹ç…©æ‚©ã‚„å¿ƒæ‰€ï¼ˆäº”åä¸€å¿ƒæ‰€ï¼‰ã‚’åˆ¤æ–­ã—ã€æŒ‡å®šã•ã‚ŒãŸå½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚
          ã€åˆ¶ç´„æ¡ä»¶ã€‘1.å¿ƒæ‰€åã«ã¯ã€ä»¥ä¸‹ã«ç¤ºã™ã€Œäº”åä¸€å¿ƒæ‰€ã€ã‹ã‚‰ã®ã¿é¸ã‚“ã§ãã ã•ã„ã€‚çµ¶å¯¾ã«ãã‚Œä»¥å¤–ã®åç§°ã‚’ä½¿ã£ã¦ã¯ã„ã‘ã¾ã›ã‚“ã€‚2.äº”åä¸€å¿ƒæ‰€ã«å­˜åœ¨ã—ãªã„å¿ƒæ‰€ï¼ˆä¾‹ãˆã°ã€Œæ…ˆæ‚²ã€ã€Œæ­£å¿µã€ã€Œé™å¯‚ã€ã€Œæ‚ªä½œã€ãªã©ï¼‰ã¯ã€å‡ºåŠ›ã«å«ã‚ãªã„ã§ãã ã•ã„ã€‚3.å‡ºåŠ›ã¯JASONã®ã¿ã§è¿”ã—ã¦ãã ã•ã„ã€‚èª¬æ˜Žæ–‡ã‚„è£œè¶³æ–‡ã‚’å«ã‚ã¦ã¯ã„ã‘ã¾ã›ã‚“ã€‚4.JASONã®ã‚­ãƒ¼ã¯ã€Œå¿ƒæ‰€ã€ã€Œå¿ƒæ‰€åˆ†é¡žã€ã€Œã‚³ãƒ¡ãƒ³ãƒˆã€ã¨ã—ã¦ãã ã•ã„ã€‚
          ã€å‡ºåŠ›å½¢å¼ã®ä¾‹ã€‘JSONå½¢å¼ã§ä»¥ä¸‹ã®æƒ…å ±ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼š1) æŠ½å‡ºã•ã‚ŒãŸå¿ƒæ‰€åï¼ˆãƒ©ãƒ™ãƒ«ã€é…åˆ—å½¢å¼ï¼‰ã€2) å¿ƒæ‰€åˆ†é¡žï¼ˆå–„ãƒ»æ‚ªãƒ»ä¸å®šãªã©ã€é…åˆ—å½¢å¼ï¼‰ã€3) ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆãªãœãã†åˆ¤æ–­ã—ãŸã‹ï¼‰ã€‚å‡ºåŠ›ã¯JSONã®ã¿ã¨ã—ã€ä»–ã®ãƒ†ã‚­ã‚¹ãƒˆã¯å«ã‚ãªã„ã§ãã ã•ã„ã€‚

ä»¥ä¸‹ã«äº”åä¸€å¿ƒæ‰€ã®ä¸€éƒ¨ã¨ãã®è§£èª¬ã‚’ç¤ºã—ã¾ã™ã€‚åˆ¤æ–­ã®å‚è€ƒã«ã—ã¦ãã ã•ã„ã€‚

--- å¿ƒæ‰€è§£èª¬ ---
ã€éè¡Œå¿ƒæ‰€ï¼ˆ5ç¨®ï¼‰ã€‘
ãƒ»ä½œæ„ï¼ˆattentionï¼‰ï¼šå¿ƒã‚’å¯¾è±¡ã«å‘ã‘ã‚‹åƒãã€‚
ãƒ»è§¦ï¼ˆcontactï¼‰ï¼šå¿ƒã¨å¯¾è±¡ãŒè§¦ã‚Œåˆã†åƒãã€‚
ãƒ»å—ï¼ˆfeelingï¼‰ï¼šå¯¾è±¡ã‚’å—ã‘æ­¢ã‚ã¦å¿«ãƒ»ä¸å¿«ãƒ»ä¸è‹¦ä¸æ¥½ã‚’æ„Ÿã˜ã‚‹åƒãã€‚ä¸»è¦³ã€‚
ãƒ»æƒ³ï¼ˆperceptionï¼‰ï¼šå¯¾è±¡ã®å§¿ã‚„ç‰¹å¾´ã‚’æ‰ãˆã‚‹åƒãã€‚å¦„æƒ³ã€‚
ãƒ»æ€ï¼ˆvolitionï¼‰ï¼šè¡Œå‹•ã¸ã¨å¿ƒã‚’å‹•ã‹ã™åƒãã€‚

ã€åˆ¥å¢ƒå¿ƒæ‰€ï¼ˆ5ç¨®ï¼‰ã€‘
ãƒ»æ¬²ï¼ˆdesireï¼‰ï¼šä½•ã‹ã‚’ã—ãŸã„ã¨é¡˜ã†å¿ƒã€‚
ãƒ»å‹è§£ï¼ˆresolveï¼‰ï¼šå¯¾è±¡ã‚’ç¢ºå®šçš„ã«ç†è§£ã—ã€ç–‘ã‚ãªã„å¿ƒã€‚
ãƒ»å¿µï¼ˆmemoryï¼‰ï¼šéŽåŽ»ã®çµŒé¨“ã‚’è¨˜æ†¶ã—ã€å¿˜ã‚Œãªã„å¿ƒã€‚æ€¨å¿µã€‚
ãƒ»å®šï¼ˆconcentrationï¼‰ï¼šå¿ƒã‚’ä¸€ç‚¹ã«é›†ä¸­ã•ã›ã‚‹å¿ƒã€‚
ãƒ»æ…§ï¼ˆwisdomï¼‰ï¼šç‰©äº‹ã‚’æ­£ã—ãè¦‹æ¥µã‚ã‚‹å¿ƒã€‚é–“é•ã£ã¦é¸æŠžã™ã‚‹å ´åˆã‚‚ã‚ã‚‹ã€‚

ã€å–„å¿ƒæ‰€ï¼ˆ11ç¨®ï¼‰ã€‘
ãƒ»ä¿¡ï¼ˆfaithï¼‰ï¼šçœŸç†ã‚„å–„ã‚’ä¿¡ã˜ã‚‹æ¸…ã‚‰ã‹ãªå¿ƒã€‚
ãƒ»ç²¾é€²ï¼ˆdiligenceï¼‰ï¼šå–„è¡Œã«åŠ±ã¿ã€æ€ ã‚‰ãªã„å¿ƒã€‚
ãƒ»æ…šï¼ˆshameï¼‰ï¼šè‡ªå·±ã®æ‚ªè¡Œã‚’æ¥ã˜ã€æ‚”ã„ã‚‹å¿ƒã€‚
ãƒ»æ„§ï¼ˆmoral apprehensionï¼‰ï¼šä»–è€…ã®å‰ã§æ‚ªã‚’ã™ã‚‹ã“ã¨ã‚’æ¥ã˜ã€æ†šã‚‹å¿ƒã€‚
ãƒ»ç„¡è²ªï¼ˆnon-attachmentï¼‰ï¼šè²ªã‚Šã‚’é›¢ã‚Œã‚‹å¿ƒã€‚
ãƒ»ç„¡çž‹ï¼ˆnon-angerï¼‰ï¼šæ€’ã‚Šã‚’é›¢ã‚Œã‚‹å¿ƒã€‚æ°—ã«å…¥ã‚‰ãªã„ã“ã¨ã¸ã®æ€’ã‚ŠãŒãªã„ã€‚
ãƒ»ç„¡ç—´ï¼ˆnon-ignoranceï¼‰ï¼šç„¡çŸ¥ã‚’é›¢ã‚Œã€æ™ºæ…§ã‚ã‚‹å¿ƒã€‚
ãƒ»è»½å®‰ï¼ˆeaseï¼‰ï¼šå¿ƒãŒè»½ã‚„ã‹ã§ç©ã‚„ã‹ãªçŠ¶æ…‹ã€‚ç¦…å®šã«å…¥ã‚‰ãªã„ã¨ç¾ã‚Œãªã„ã®ã§å‡¡äººã«ã¯é©ç”¨ã§ããªã„ã€‚
ãƒ»ä¸æ”¾é€¸ï¼ˆconscientiousnessï¼‰ï¼šå–„è¡Œã‚’å¿˜ã‚Œãšã€æ€ ã‚‰ãªã„å¿ƒã€‚
ãƒ»è¡Œæ¨ï¼ˆequanimityï¼‰ï¼šå¿ƒã‚’å¹³ç­‰ã«ã—ã€å¹³é™ã‚’ä¿ã¤å¿ƒã€‚ãã‚ŒãŒå®Ÿè¡Œã§ãã¦ã„ã‚‹ã“ã¨ã€‚
ãƒ»ä¸å®³ï¼ˆnon-harmï¼‰ï¼šä»–è€…ã‚’å®³ã•ãªã„å¿ƒã€‚

ã€æ ¹æœ¬ç…©æ‚©ï¼ˆ6ç¨®ï¼‰ã€‘
ãƒ»è²ªï¼ˆgreedï¼‰ï¼šå¯¾è±¡ã«åŸ·ç€ã—ã€é£½ããªãæ¬²æœ›ã‚’æŠ±ãå¿ƒã€‚
ãƒ»çž‹ï¼ˆangerï¼‰ï¼šå¯¾è±¡ã«æ€’ã‚Šã‚„ä¸æº€ã‚’æŠ±ãå¿ƒã€‚æ°—ã«å…¥ã‚‰ãªã„ã‚‚ã®ã«å¯¾ã™ã‚‹æ€’ã‚Šã€‚
ãƒ»ç—´ï¼ˆignoranceï¼‰ï¼šç‰©äº‹ã®çœŸå®Ÿã‚’çŸ¥ã‚‰ãªã„ç„¡æ˜Žã®å¿ƒã€‚
ãƒ»æ…¢ï¼ˆarroganceï¼‰ï¼šè‡ªåˆ†ã‚’ä»–è€…ã‚ˆã‚Šå„ªã‚Œã¦ã„ã‚‹ã¨è¦‹ãªã™å¿ƒã€‚
ãƒ»ç–‘ï¼ˆdoubtï¼‰ï¼šçœŸç†ã‚„å–„ã‚’ç–‘ã†å¿ƒã€‚
ãƒ»æ‚ªè¦‹ï¼ˆwrong viewsï¼‰ï¼šèª¤ã£ãŸè¦‹è§£ã‚’æŒã¤å¿ƒã€‚

ã€éšç…©æ‚©ï¼ˆ20ç¨®ï¼‰ã€‘
ãƒ»å¿¿ï¼ˆindignationï¼‰ï¼šçž¬é–“çš„ãªæ¿€ã—ã„æ€’ã‚Šã€‚
ãƒ»æ¨ï¼ˆrancorï¼‰ï¼šæ€’ã‚Šã‚’é•·ãæŒã¡ç¶šã‘ã‚‹å¿ƒã€‚
ãƒ»è¦†ï¼ˆconcealmentï¼‰ï¼šéŽã¡ã‚’éš ãã†ã¨ã™ã‚‹å¿ƒã€‚
ãƒ»æ‚©ï¼ˆvexationï¼‰ï¼šã„ã‚‰ã ã¡ã‚„è‹¦æ‚©ã€‚éŽåŽ»ã«ã—ãŒã¿ã¤ãã€‚
ãƒ»å«‰ï¼ˆenvyï¼‰ï¼šä»–è€…ã®æˆåŠŸã‚’ã­ãŸã‚€å¿ƒã€‚
ãƒ»æ…³ï¼ˆmiserlinessï¼‰ï¼šè‡ªåˆ†ã®ã‚‚ã®ã‚’å‡ºã—æƒœã—ã¿ã™ã‚‹å¿ƒã€‚
ãƒ»èª‘ï¼ˆdeceptionï¼‰ï¼šäººã‚’æ¬ºãå¿ƒã€‚
ãƒ»è«‚ï¼ˆflatteryï¼‰ï¼šä»–äººã«ã“ã³ã¸ã¤ã‚‰ã†å¿ƒã€‚
ãƒ»å®³ï¼ˆharmï¼‰ï¼šä»–è€…ã‚’å‚·ã¤ã‘ã‚ˆã†ã¨ã™ã‚‹å¿ƒã€‚
ãƒ»æ†ï¼ˆhaughtinessï¼‰ï¼šå¾—æ„ã«ãªã£ã¦é«˜ã¶ã‚‹å¿ƒã€‚
ãƒ»ç„¡æ…šï¼ˆshamelessnessï¼‰ï¼šæ¥ã‚’çŸ¥ã‚‰ãªã„å¿ƒã€‚
ãƒ»ç„¡æ„§ï¼ˆlack of moral apprehensionï¼‰ï¼šä»–äººã‚’æ°—ã«ã›ãšæ‚ªã‚’è¡Œã†å¿ƒã€‚
ãƒ»æŽ‰æŒ™ï¼ˆrestlessnessï¼‰ï¼šå¿ƒãŒè½ã¡ç€ã‹ãšã€æµ®ã¤ãå¿ƒã€‚
ãƒ»æ˜æ²ˆï¼ˆslothï¼‰ï¼šå¿ƒãŒæ²ˆã¿ã€æ„æ¬²ãŒãªã„å¿ƒã€‚
ãƒ»ä¸ä¿¡ï¼ˆlack of faithï¼‰ï¼šä¿¡ã˜ãªã„å¿ƒã€‚
ãƒ»æ‡ˆæ€ ï¼ˆindolenceï¼‰ï¼šåŠªåŠ›ã‚’æ€ ã‚‹å¿ƒã€‚
ãƒ»æ”¾é€¸ï¼ˆheedlessnessï¼‰ï¼šå¿ƒã‚’æ”¾ä»»ã—ã€æ°—ã‚’ã¤ã‘ãªã„å¿ƒã€‚
ãƒ»æ•£ä¹±ï¼ˆdistractionï¼‰ï¼šå¿ƒãŒæ•£æ¼«ã«ãªã‚‹å¿ƒã€‚
ãƒ»ä¸æ­£çŸ¥ï¼ˆwrong understandingï¼‰ï¼šæ­£ã—ãç†è§£ã—ãªã„å¿ƒã€‚
ãƒ»å¤±å¿µï¼ˆforgottenï¼‰ï¼šçœŸç†ã‚„å¾³ã‚’å¿˜ã‚Œã‚‹ã“ã¨ã€‚

ã€ä¸å®šå¿ƒæ‰€ï¼ˆ4ç¨®ï¼‰ã€‘
ãƒ»æ‚”ï¼ˆregretï¼‰ï¼šéŽåŽ»ã®è¡Œã„ã‚’æ‚”ã‚„ã‚€å¿ƒã€‚
ãƒ»çœ ï¼ˆsleepï¼‰ï¼šå¿ƒãŒæ²ˆã‚“ã§çœ ã‚Šã«è½ã¡ã‚‹çŠ¶æ…‹ã€‚
ãƒ»å°‹ï¼ˆinquiryï¼‰ï¼šå¿ƒã§è¨€è‘‰ã‚„æ„å‘³ã‚’æŽ¢ã—æ±‚ã‚ã‚‹å¿ƒã€‚
ãƒ»ä¼ºï¼ˆinvestigationï¼‰ï¼šå¯¾è±¡ã‚’ç´°ã‹ãè€ƒå¯Ÿã™ã‚‹å¿ƒã€‚

å›žç­”ä¾‹: {"å¿ƒæ‰€":["ä¿¡","ä¸å®³"],"å¿ƒæ‰€åˆ†é¡ž":["å–„å¿ƒæ‰€"],"ã‚³ãƒ¡ãƒ³ãƒˆ":"ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ¸…ã‚‰ã‹ãªå¿ƒã‚’è¡¨ã—ã¦ã„ã¾ã™ã€‚"}
å›žç­”ä¾‹: {"å¿ƒæ‰€":["çž‹","å¿¿"],"å¿ƒæ‰€åˆ†é¡ž":["æ ¹æœ¬ç…©æ‚©","éšç…©æ‚©"],"ã‚³ãƒ¡ãƒ³ãƒˆ":"ç‰¹å®šã®å¯¾è±¡ã¸ã®æ€’ã‚ŠãŒèª­ã¿å–ã‚Œã¾ã™ã€‚"}
å›žç­”ä¾‹: {"å¿ƒæ‰€":["æŽ‰æŒ™"],"å¿ƒæ‰€åˆ†é¡ž":["éšç…©æ‚©"],"ã‚³ãƒ¡ãƒ³ãƒˆ":"å¿ƒãŒè½ã¡ç€ã‹ãªã„çŠ¶æ…‹ã§ã™ã€‚"}

å¿…ãšJSONå½¢å¼ã§å›žç­”ã—ã¦ãã ã•ã„ã€‚ä»–ã®ãƒ†ã‚­ã‚¹ãƒˆã¯ä¸€åˆ‡å«ã‚ãªã„ã§ãã ã•ã„ã€‚`
        },
        {
          role: "user",
          content: `ã“ã®æ–‡ç« ã®å¿ƒæ‰€ã‚’ãƒ©ãƒ™ãƒªãƒ³ã‚°ã—ã¦ãã ã•ã„ï¼šã€Œ${text}ã€`
        }
      ],
      temperature: 0.3,
    });

    const result = completion.choices[0].message.content;
    console.log("GPT-4ã‹ã‚‰ã®ãƒ©ãƒ™ãƒªãƒ³ã‚°çµæžœï¼ˆRawï¼‰:", result);
    return JSON.parse(result);
  } catch (error) {
    console.error("OpenAI APIã‚¨ãƒ©ãƒ¼:", error.response ? error.response.data : error.message);
    return null;
  }
}
app.post('/', async (req, res) => {
  console.log('ðŸ“¬ Webhook received:', JSON.stringify(req.body, null, 2));

  const events = req.body.events;

  if (!events || events.length === 0) {
    console.log('ðŸ’¡ No events in webhook body. Sending 200.');
    return res.sendStatus(200);
  }

  for (const event of events) {
    console.log('âž¡ï¸ Processing event:', JSON.stringify(event, null, 2));

    if (event.type === 'message' && event.message && event.message.type === 'text') {
      const text = event.message.text;
      console.log('  - Detected text message:', text);

      const receivedTimestamp = new Date(event.timestamp).toISOString();
      console.log('  - Message timestamp:', receivedTimestamp);

      let notionProperties = {
        "åå‰": {
          title: [
            {
              text: {
                content: text,
              },
            },
          ],
        },
        "ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—": {
          date: {
            start: receivedTimestamp,
          },
        },
      };

      const labelResult = await classifyMindFactors(text);

      if (labelResult) {
        if (labelResult.å¿ƒæ‰€ && Array.isArray(labelResult.å¿ƒæ‰€)) {
          notionProperties["å¿ƒæ‰€ãƒ©ãƒ™ãƒ«"] = {
            multi_select: labelResult.å¿ƒæ‰€.map(tag => ({ name: tag })),
          };
        }
        if (labelResult.å¿ƒæ‰€åˆ†é¡ž && Array.isArray(labelResult.å¿ƒæ‰€åˆ†é¡ž)) {
          notionProperties["å¿ƒæ‰€åˆ†é¡ž"] = {
            multi_select: labelResult.å¿ƒæ‰€åˆ†é¡ž.map(tag => ({ name: tag })),
          };
        }
        if (labelResult.ã‚³ãƒ¡ãƒ³ãƒˆ) {
          notionProperties["å¿ƒæ‰€ã‚³ãƒ¡ãƒ³ãƒˆ"] = {
            rich_text: [
              {
                text: {
                  content: labelResult.ã‚³ãƒ¡ãƒ³ãƒˆ,
                },
              },
            ],
          };
        }
        console.log('  - AIãƒ©ãƒ™ãƒªãƒ³ã‚°çµæžœã‚’Notionãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«è¿½åŠ ã—ã¾ã—ãŸã€‚');
      } else {
        console.warn('  - AIãƒ©ãƒ™ãƒªãƒ³ã‚°ã«å¤±æ•—ã—ãŸãŸã‚ã€Notionã«ãƒ©ãƒ™ãƒªãƒ³ã‚°çµæžœã¯è¿½åŠ ã•ã‚Œã¾ã›ã‚“ã€‚');
      }

      try {
        await notion.pages.create({
          parent: { database_id: process.env.NOTION_DATABASE_ID },
          properties: notionProperties,
        });
        console.log('âœ… Notion ã«æ›¸ãè¾¼ã¿å®Œäº†:', text);
      } catch (error) {
        console.error('âŒ Notion æ›¸ãè¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
      }
    } else {
      console.log('  - Message is not a text message or text property is missing for type:', event.message?.type);
    }
  }

  res.sendStatus(200);
});

const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
  console.log(`ðŸš€ Server is running on port ${PORT}`);
});
